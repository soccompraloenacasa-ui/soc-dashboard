<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOC Hub - Compralo en Casa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ml: '#eab308',
            dropi: '#ea580c',
            shopify: '#16a34a',
            gastos: '#dc2626',
            profit: '#2563eb',
          }
        }
      }
    }
  </script>
  <style>
    .date-in-range { background: rgba(37, 99, 235, 0.3); }
    .date-selected { background: #2563eb; color: white; border-radius: 6px; }
    .date-start { border-radius: 6px 0 0 6px; }
    .date-end { border-radius: 0 6px 6px 0; }
    .date-single { border-radius: 6px; }
    .nav-item.active { background: #242424; color: white; }
    .sub-nav-item.active { background: #242424; color: white; }
  </style>
</head>
<body class="bg-[#0a0a0a] text-white min-h-screen">
  
  <div class="flex h-screen overflow-hidden">
    
    <!-- SIDEBAR -->
    <aside class="w-64 bg-[#121212] border-r border-[#2e2e2e] flex flex-col">
      <div class="p-6 border-b border-[#2e2e2e]">
        <h1 class="text-xl font-bold flex items-center gap-2">üè† SOC Hub</h1>
        <p class="text-gray-500 text-sm">Compralo en Casa</p>
      </div>
      
      <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
        <!-- Dashboard -->
        <a href="#" onclick="navigateTo('dashboard')" id="nav-dashboard" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-[#1a1a1a] transition">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
          Dashboard
        </a>
        
        <!-- Mercado Libre con sub-men√∫ -->
        <div class="space-y-1">
          <a href="#" onclick="toggleMLMenu()" id="nav-ml" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-[#1a1a1a] transition">
            <i data-lucide="shopping-bag" class="w-5 h-5 text-ml"></i>
            Mercado Libre
            <i data-lucide="chevron-down" class="w-4 h-4 ml-auto transition-transform" id="ml-chevron"></i>
          </a>
          
          <!-- Sub-men√∫ ML -->
          <div id="ml-submenu" class="hidden ml-4 space-y-1">
            <a href="#" onclick="navigateTo('ml-resumen')" id="nav-ml-resumen" class="sub-nav-item flex items-center gap-2 px-4 py-2 rounded-lg text-sm text-gray-400 hover:bg-[#1a1a1a] transition">
              <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
              Resumen General
            </a>
            <a href="#" onclick="navigateTo('ml-cuenta1')" id="nav-ml-cuenta1" class="sub-nav-item flex items-center gap-2 px-4 py-2 rounded-lg text-sm text-gray-400 hover:bg-[#1a1a1a] transition">
              <i data-lucide="building-2" class="w-4 h-4"></i>
              COMPRALOENCASA
            </a>
            <a href="#" onclick="navigateTo('ml-cuenta2')" id="nav-ml-cuenta2" class="sub-nav-item flex items-center gap-2 px-4 py-2 rounded-lg text-sm text-gray-400 hover:bg-[#1a1a1a] transition opacity-50">
              <i data-lucide="building-2" class="w-4 h-4"></i>
              Cuenta 2 (pronto)
            </a>
            <a href="#" onclick="navigateTo('ml-cuenta3')" id="nav-ml-cuenta3" class="sub-nav-item flex items-center gap-2 px-4 py-2 rounded-lg text-sm text-gray-400 hover:bg-[#1a1a1a] transition opacity-50">
              <i data-lucide="building-2" class="w-4 h-4"></i>
              Cuenta 3 (pronto)
            </a>
            <a href="#" onclick="navigateTo('ml-productos')" id="nav-ml-productos" class="sub-nav-item flex items-center gap-2 px-4 py-2 rounded-lg text-sm text-gray-400 hover:bg-[#1a1a1a] transition">
              <i data-lucide="package" class="w-4 h-4"></i>
              Todos los Productos
            </a>
          </div>
        </div>
        
        <!-- Dropi -->
        <a href="#" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-[#1a1a1a] transition opacity-50">
          <i data-lucide="package" class="w-5 h-5 text-dropi"></i>
          Dropi (pronto)
        </a>
        
        <!-- Shopify -->
        <a href="#" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-[#1a1a1a] transition opacity-50">
          <i data-lucide="store" class="w-5 h-5 text-shopify"></i>
          Shopify (pronto)
        </a>
      </nav>
      
      <!-- Sync Status -->
      <div class="p-4 border-t border-[#2e2e2e]">
        <div id="syncStatus" class="bg-[#1a1a1a] rounded-lg p-3">
          <div class="flex items-center gap-2 text-sm text-gray-500">
            <i data-lucide="loader" class="w-4 h-4 animate-spin"></i>
            Cargando...
          </div>
        </div>
      </div>
    </aside>
    
    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-auto">
      
      <!-- VISTA: DASHBOARD -->
      <div id="view-dashboard" class="view">
        <header class="bg-[#121212] border-b border-[#2e2e2e] px-6 py-4 sticky top-0 z-20">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-2xl font-bold">Dashboard</h2>
              <p class="text-gray-500">Vista consolidada de todos los canales</p>
            </div>
            <div class="flex items-center gap-4">
              <div class="relative">
                <button id="datePickerBtn" onclick="toggleDatePicker()" class="flex items-center gap-2 bg-[#1a1a1a] rounded-lg px-4 py-2 hover:bg-[#242424] transition border border-[#2e2e2e]">
                  <i data-lucide="calendar" class="w-4 h-4 text-gray-400"></i>
                  <span id="dateRangeLabel" class="text-sm">√öltimos 30 d√≠as</span>
                  <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400"></i>
                </button>
                <div id="datePickerDropdown" class="hidden absolute right-0 top-12 bg-[#1a1a1a] border border-[#2e2e2e] rounded-xl shadow-2xl p-4 w-[320px] z-50">
                  <div class="flex flex-wrap gap-2 mb-4 pb-4 border-b border-[#2e2e2e]">
                    <button onclick="setQuickRange(7)" class="px-3 py-1.5 text-xs bg-[#242424] hover:bg-[#2e2e2e] rounded-lg transition">7 d√≠as</button>
                    <button onclick="setQuickRange(30)" class="px-3 py-1.5 text-xs bg-[#242424] hover:bg-[#2e2e2e] rounded-lg transition">30 d√≠as</button>
                    <button onclick="setQuickRange(90)" class="px-3 py-1.5 text-xs bg-[#242424] hover:bg-[#2e2e2e] rounded-lg transition">90 d√≠as</button>
                    <button onclick="setQuickRange(365)" class="px-3 py-1.5 text-xs bg-[#242424] hover:bg-[#2e2e2e] rounded-lg transition">1 a√±o</button>
                    <button onclick="setQuickRange('all')" class="px-3 py-1.5 text-xs bg-[#242424] hover:bg-[#2e2e2e] rounded-lg transition">Todo</button>
                  </div>
                  <div class="flex items-center justify-between mb-3">
                    <button onclick="changeMonth(-1)" class="p-1 hover:bg-[#242424] rounded-lg transition"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                    <span id="calendarMonth" class="font-semibold"></span>
                    <button onclick="changeMonth(1)" class="p-1 hover:bg-[#242424] rounded-lg transition"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                  </div>
                  <div class="grid grid-cols-7 gap-1 text-center text-xs mb-2">
                    <div class="text-gray-500 py-1">Lu</div><div class="text-gray-500 py-1">Ma</div><div class="text-gray-500 py-1">Mi</div><div class="text-gray-500 py-1">Ju</div><div class="text-gray-500 py-1">Vi</div><div class="text-gray-500 py-1">Sa</div><div class="text-gray-500 py-1">Do</div>
                  </div>
                  <div id="calendarDays" class="grid grid-cols-7 gap-1 text-center text-sm"></div>
                  <div class="mt-4 pt-4 border-t border-[#2e2e2e] flex items-center justify-between">
                    <div class="text-xs text-gray-400"><span id="selectedRangeText">Selecciona un rango</span></div>
                    <button onclick="applyDateRange()" class="px-4 py-1.5 bg-profit text-white text-sm font-medium rounded-lg hover:bg-blue-600 transition">Aplicar</button>
                  </div>
                </div>
              </div>
              <button onclick="loadAllData()" class="px-4 py-2 bg-ml text-black font-medium rounded-lg hover:bg-yellow-400 transition flex items-center gap-2">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i>Actualizar
              </button>
            </div>
          </div>
        </header>
        
        <div class="p-6 space-y-6">
          <div id="loadingState" class="text-center py-20">
            <i data-lucide="loader" class="w-12 h-12 animate-spin mx-auto text-ml mb-4"></i>
            <p class="text-gray-400">Cargando datos...</p>
          </div>
          <div id="errorState" class="hidden text-center py-20">
            <i data-lucide="alert-circle" class="w-12 h-12 mx-auto text-red-500 mb-4"></i>
            <p class="text-red-400 font-medium">Error al cargar datos</p>
            <p class="text-gray-500 text-sm mt-2" id="errorMessage"></p>
            <button onclick="loadAllData()" class="mt-4 px-4 py-2 bg-[#1a1a1a] rounded-lg hover:bg-[#242424] transition">Reintentar</button>
          </div>
          <div id="dashboardContent" class="hidden space-y-6">
            <div class="grid grid-cols-4 gap-4">
              <div class="bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
                <div class="flex items-center justify-between mb-3">
                  <span class="text-gray-500 text-sm">Ventas Totales</span>
                  <div class="p-2 bg-shopify/20 rounded-lg"><i data-lucide="dollar-sign" class="w-5 h-5 text-shopify"></i></div>
                </div>
                <p class="text-2xl font-bold" id="totalRevenue">$0</p>
                <p class="text-sm mt-1 font-medium" id="revenueChange">-</p>
              </div>
              <div class="bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
                <div class="flex items-center justify-between mb-3">
                  <span class="text-gray-500 text-sm">√ìrdenes</span>
                  <div class="p-2 bg-ml/20 rounded-lg"><i data-lucide="shopping-cart" class="w-5 h-5 text-ml"></i></div>
                </div>
                <p class="text-2xl font-bold" id="totalOrders">0</p>
                <p class="text-sm mt-1 font-medium" id="ordersChange">-</p>
              </div>
              <div class="bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
                <div class="flex items-center justify-between mb-3">
                  <span class="text-gray-500 text-sm">Ticket Promedio</span>
                  <div class="p-2 bg-dropi/20 rounded-lg"><i data-lucide="tag" class="w-5 h-5 text-dropi"></i></div>
                </div>
                <p class="text-2xl font-bold" id="avgTicket">$0</p>
                <p class="text-gray-500 text-sm mt-1">por orden</p>
              </div>
              <div class="bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
                <div class="flex items-center justify-between mb-3">
                  <span class="text-gray-500 text-sm">√ìrdenes Sincronizadas</span>
                  <div class="p-2 bg-profit/20 rounded-lg"><i data-lucide="database" class="w-5 h-5 text-profit"></i></div>
                </div>
                <p class="text-2xl font-bold" id="syncedOrders">0</p>
                <p class="text-gray-500 text-sm mt-1" id="dateRangeInfo">-</p>
              </div>
            </div>
            <div class="grid grid-cols-3 gap-4">
              <div class="col-span-2 bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-semibold">Ventas por D√≠a</h3>
                  <span class="text-ml text-sm flex items-center gap-1"><span class="w-2 h-2 bg-ml rounded-full"></span>Mercado Libre</span>
                </div>
                <canvas id="salesChart" height="200"></canvas>
              </div>
              <div class="bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
                <h3 class="font-semibold mb-4">Estado de √ìrdenes</h3>
                <canvas id="statusChart" height="200"></canvas>
                <div id="statusLegend" class="mt-4 space-y-2 text-sm"></div>
              </div>
            </div>
            <div class="bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold">Top 10 Productos</h3>
                <button onclick="navigateTo('ml-productos')" class="text-sm text-ml hover:underline">Ver todos ‚Üí</button>
              </div>
              <table class="w-full">
                <thead>
                  <tr class="text-left text-gray-500 text-sm border-b border-[#2e2e2e]">
                    <th class="pb-3 font-medium">#</th>
                    <th class="pb-3 font-medium">Producto</th>
                    <th class="pb-3 font-medium text-right">Unidades</th>
                    <th class="pb-3 font-medium text-right">Ingresos</th>
                    <th class="pb-3 font-medium text-right">√ìrdenes</th>
                  </tr>
                </thead>
                <tbody id="productsTable" class="text-sm"></tbody>
              </table>
            </div>
            <div class="bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
              <h3 class="font-semibold mb-4">√ìrdenes Recientes</h3>
              <table class="w-full">
                <thead>
                  <tr class="text-left text-gray-500 text-sm border-b border-[#2e2e2e]">
                    <th class="pb-3 font-medium">ID</th>
                    <th class="pb-3 font-medium">Fecha</th>
                    <th class="pb-3 font-medium">Comprador</th>
                    <th class="pb-3 font-medium">Estado</th>
                    <th class="pb-3 font-medium text-right">Total</th>
                  </tr>
                </thead>
                <tbody id="ordersTable" class="text-sm"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- VISTA: ML RESUMEN -->
      <div id="view-ml-resumen" class="view hidden">
        <header class="bg-[#121212] border-b border-[#2e2e2e] px-6 py-4 sticky top-0 z-20">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-2xl font-bold flex items-center gap-2"><i data-lucide="shopping-bag" class="w-6 h-6 text-ml"></i>Mercado Libre - Resumen</h2>
              <p class="text-gray-500">Vista consolidada de todas las cuentas</p>
            </div>
            <button onclick="loadMLResumen()" class="px-4 py-2 bg-ml text-black font-medium rounded-lg hover:bg-yellow-400 transition flex items-center gap-2">
              <i data-lucide="refresh-cw" class="w-4 h-4"></i>Actualizar
            </button>
          </div>
        </header>
        <div class="p-6 space-y-6">
          <div class="grid grid-cols-3 gap-4">
            <div onclick="navigateTo('ml-cuenta1')" class="bg-[#1a1a1a] rounded-xl p-5 border-l-4 border-ml cursor-pointer hover:bg-[#242424] transition">
              <div class="flex items-center justify-between mb-3">
                <span class="text-ml font-medium">COMPRALOENCASA</span>
                <span class="text-xs bg-ml/20 text-ml px-2 py-1 rounded">Activa</span>
              </div>
              <p class="text-2xl font-bold" id="ml-cuenta1-revenue">$0</p>
              <p class="text-gray-500 text-sm" id="ml-cuenta1-orders">0 √≥rdenes</p>
            </div>
            <div class="bg-[#1a1a1a] rounded-xl p-5 border-l-4 border-gray-600 opacity-50">
              <div class="flex items-center justify-between mb-3">
                <span class="text-gray-400 font-medium">Cuenta 2</span>
                <span class="text-xs bg-gray-500/20 text-gray-400 px-2 py-1 rounded">Pendiente</span>
              </div>
              <p class="text-2xl font-bold text-gray-600">-</p>
              <p class="text-gray-600 text-sm">Sin conectar</p>
            </div>
            <div class="bg-[#1a1a1a] rounded-xl p-5 border-l-4 border-gray-600 opacity-50">
              <div class="flex items-center justify-between mb-3">
                <span class="text-gray-400 font-medium">Cuenta 3</span>
                <span class="text-xs bg-gray-500/20 text-gray-400 px-2 py-1 rounded">Pendiente</span>
              </div>
              <p class="text-2xl font-bold text-gray-600">-</p>
              <p class="text-gray-600 text-sm">Sin conectar</p>
            </div>
          </div>
          <div class="bg-gradient-to-r from-ml/20 to-ml/5 rounded-xl p-6 border border-ml/30">
            <h3 class="text-lg font-semibold mb-4 text-ml">üìä Totales Consolidados</h3>
            <div class="grid grid-cols-5 gap-6">
              <div>
                <p class="text-gray-400 text-sm">Ventas Brutas</p>
                <p class="text-3xl font-bold text-green-500" id="ml-total-revenue">$0</p>
              </div>
              <div>
                <p class="text-gray-400 text-sm">√ìrdenes</p>
                <p class="text-3xl font-bold" id="ml-total-orders">0</p>
              </div>
              <div>
                <p class="text-gray-400 text-sm">Costo Env√≠os</p>
                <p class="text-3xl font-bold text-orange-500" id="ml-total-shipping">-$0</p>
              </div>
              <div>
                <p class="text-gray-400 text-sm">Fees ML</p>
                <p class="text-3xl font-bold text-red-500" id="ml-total-fees">-$0</p>
              </div>
              <div class="bg-green-500/20 rounded-lg p-3 -m-1">
                <p class="text-gray-400 text-sm">Neto</p>
                <p class="text-3xl font-bold text-green-400" id="ml-total-net">$0</p>
              </div>
            </div>
          </div>
          <div class="bg-[#1a1a1a] rounded-xl p-6 border border-dashed border-[#2e2e2e]">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <div class="p-3 bg-ml/20 rounded-lg"><i data-lucide="plus" class="w-6 h-6 text-ml"></i></div>
                <div>
                  <p class="font-semibold">Conectar otra cuenta de Mercado Libre</p>
                  <p class="text-gray-500 text-sm">Vincula tus otras cuentas para ver todo consolidado</p>
                </div>
              </div>
              <button class="px-4 py-2 bg-ml text-black font-medium rounded-lg hover:bg-yellow-400 transition">Conectar Cuenta</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- VISTA: ML CUENTA 1 -->
      <div id="view-ml-cuenta1" class="view hidden">
        <header class="bg-[#121212] border-b border-[#2e2e2e] px-6 py-4 sticky top-0 z-20">
          <div class="flex items-center justify-between">
            <div>
              <div class="flex items-center gap-2 mb-1">
                <button onclick="navigateTo('ml-resumen')" class="text-gray-400 hover:text-white"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                <h2 class="text-2xl font-bold">COMPRALOENCASA</h2>
                <span class="text-xs bg-ml/20 text-ml px-2 py-1 rounded">Principal</span>
              </div>
              <p class="text-gray-500">ID: 108098646 ‚Ä¢ Canal 1</p>
            </div>
            <button onclick="loadMLCuenta1()" class="px-4 py-2 bg-ml text-black font-medium rounded-lg hover:bg-yellow-400 transition flex items-center gap-2">
              <i data-lucide="refresh-cw" class="w-4 h-4"></i>Actualizar
            </button>
          </div>
        </header>
        <div class="p-6 space-y-6">
          <div class="grid grid-cols-5 gap-4">
            <div class="bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
              <span class="text-gray-500 text-sm">Ventas</span>
              <p class="text-2xl font-bold mt-1 text-green-500" id="c1-revenue">$0</p>
            </div>
            <div class="bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
              <span class="text-gray-500 text-sm">√ìrdenes</span>
              <p class="text-2xl font-bold mt-1" id="c1-orders">0</p>
            </div>
            <div class="bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
              <span class="text-gray-500 text-sm">Env√≠os</span>
              <p class="text-2xl font-bold mt-1 text-orange-500" id="c1-shipping">$0</p>
            </div>
            <div class="bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
              <span class="text-gray-500 text-sm">Fees ML</span>
              <p class="text-2xl font-bold mt-1 text-red-500" id="c1-fees">$0</p>
            </div>
            <div class="bg-green-500/10 rounded-xl p-5 border border-green-500/30">
              <span class="text-gray-500 text-sm">Neto</span>
              <p class="text-2xl font-bold mt-1 text-green-400" id="c1-net">$0</p>
            </div>
          </div>
          <div class="bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
            <h3 class="font-semibold mb-4">Desglose por Estado</h3>
            <div class="grid grid-cols-4 gap-4" id="c1-status-breakdown"></div>
          </div>
          <div class="bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold">Productos de esta cuenta</h3>
              <button onclick="navigateTo('ml-productos')" class="text-sm text-ml hover:underline">Ver todos ‚Üí</button>
            </div>
            <table class="w-full text-sm">
              <thead>
                <tr class="text-gray-500 border-b border-[#2e2e2e]">
                  <th class="text-left pb-3">#</th>
                  <th class="text-left pb-3">Producto</th>
                  <th class="text-right pb-3">Unidades</th>
                  <th class="text-right pb-3">Ingresos</th>
                </tr>
              </thead>
              <tbody id="c1-products"></tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- VISTA: ML PRODUCTOS -->
      <div id="view-ml-productos" class="view hidden">
        <header class="bg-[#121212] border-b border-[#2e2e2e] px-6 py-4 sticky top-0 z-20">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-2xl font-bold flex items-center gap-2"><i data-lucide="package" class="w-6 h-6 text-ml"></i>Todos los Productos</h2>
              <p class="text-gray-500">Lista completa de productos vendidos</p>
            </div>
            <div class="flex items-center gap-4">
              <input type="text" id="productSearch" oninput="filterProducts()" placeholder="Buscar producto..." class="bg-[#1a1a1a] border border-[#2e2e2e] rounded-lg px-4 py-2 text-sm w-64">
              <button onclick="loadMLProductos()" class="px-4 py-2 bg-ml text-black font-medium rounded-lg hover:bg-yellow-400 transition flex items-center gap-2">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i>Actualizar
              </button>
            </div>
          </div>
        </header>
        <div class="p-6">
          <div class="bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
            <div class="flex items-center justify-between mb-4">
              <span class="text-gray-500 text-sm">Mostrando <span id="products-showing">0</span> de <span id="products-total">0</span> productos</span>
              <select id="productSort" onchange="sortProducts()" class="bg-[#242424] border border-[#2e2e2e] rounded-lg px-3 py-1.5 text-sm">
                <option value="revenue">Mayor ingreso</option>
                <option value="units">M√°s vendidos</option>
                <option value="orders">M√°s √≥rdenes</option>
                <option value="name">Nombre A-Z</option>
              </select>
            </div>
            <table class="w-full text-sm">
              <thead>
                <tr class="text-gray-500 border-b border-[#2e2e2e]">
                  <th class="text-left pb-3 font-medium">#</th>
                  <th class="text-left pb-3 font-medium">Producto</th>
                  <th class="text-right pb-3 font-medium">Unidades</th>
                  <th class="text-right pb-3 font-medium">Ingresos</th>
                  <th class="text-right pb-3 font-medium">√ìrdenes</th>
                  <th class="text-right pb-3 font-medium">Ticket Prom.</th>
                </tr>
              </thead>
              <tbody id="all-products-table"></tbody>
            </table>
            <div class="flex items-center justify-between mt-4 pt-4 border-t border-[#2e2e2e]">
              <button onclick="prevProductPage()" id="prev-page-btn" class="px-4 py-2 bg-[#242424] rounded-lg hover:bg-[#2e2e2e] disabled:opacity-50" disabled>‚Üê Anterior</button>
              <span class="text-gray-500 text-sm">P√°gina <span id="current-page">1</span> de <span id="total-pages">1</span></span>
              <button onclick="nextProductPage()" id="next-page-btn" class="px-4 py-2 bg-[#242424] rounded-lg hover:bg-[#2e2e2e] disabled:opacity-50">Siguiente ‚Üí</button>
            </div>
          </div>
        </div>
      </div>
      
    </main>
  </div>
  
  <script>
    const API_BASE = 'https://mercado-libre-production-b0cc.up.railway.app/api/v1';
    const CHANNEL_ID = 1;
    let salesChart = null, statusChart = null, allProducts = [], filteredProducts = [], currentPage = 1;
    const productsPerPage = 20;
    let currentMonth = new Date(), startDate = null, endDate = null, selectingStart = true;
    const today = new Date();
    endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    startDate = new Date(endDate); startDate.setDate(startDate.getDate() - 30);
    let mlMenuOpen = false;
    
    function toggleMLMenu() {
      mlMenuOpen = !mlMenuOpen;
      document.getElementById('ml-submenu').classList.toggle('hidden', !mlMenuOpen);
      document.getElementById('ml-chevron').style.transform = mlMenuOpen ? 'rotate(180deg)' : 'rotate(0deg)';
    }
    
    function navigateTo(view) {
      document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
      document.getElementById('view-' + view).classList.remove('hidden');
      document.querySelectorAll('.nav-item, .sub-nav-item').forEach(n => n.classList.remove('active'));
      if (view === 'dashboard') document.getElementById('nav-dashboard').classList.add('active');
      else if (view.startsWith('ml-')) {
        document.getElementById('nav-ml').classList.add('active');
        document.getElementById('nav-' + view)?.classList.add('active');
        if (!mlMenuOpen) toggleMLMenu();
      }
      if (view === 'dashboard') loadAllData();
      else if (view === 'ml-resumen') loadMLResumen();
      else if (view === 'ml-cuenta1') loadMLCuenta1();
      else if (view === 'ml-productos') loadMLProductos();
      lucide.createIcons();
    }
    
    function toggleDatePicker() { document.getElementById('datePickerDropdown').classList.toggle('hidden'); if (!document.getElementById('datePickerDropdown').classList.contains('hidden')) { renderCalendar(); lucide.createIcons(); } }
    function closeDatePicker() { document.getElementById('datePickerDropdown').classList.add('hidden'); }
    document.addEventListener('click', (e) => { const p = document.getElementById('datePickerDropdown'), b = document.getElementById('datePickerBtn'); if (p && b && !p.contains(e.target) && !b.contains(e.target)) p.classList.add('hidden'); });
    function changeMonth(d) { currentMonth.setMonth(currentMonth.getMonth() + d); renderCalendar(); }
    function renderCalendar() {
      const m = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
      document.getElementById('calendarMonth').textContent = `${m[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
      const f = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1), l = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
      let s = f.getDay() - 1; if (s < 0) s = 6;
      const c = document.getElementById('calendarDays'); c.innerHTML = '';
      for (let i = 0; i < s; i++) c.innerHTML += '<div class="py-2"></div>';
      for (let d = 1; d <= l.getDate(); d++) {
        const dt = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), d), ds = dt.toISOString().split('T')[0];
        let cls = 'py-2 cursor-pointer hover:bg-[#242424] rounded-lg transition';
        if (startDate && endDate) { if (isSameDay(dt, startDate) && isSameDay(dt, endDate)) cls += ' date-selected date-single'; else if (isSameDay(dt, startDate)) cls += ' date-selected date-start'; else if (isSameDay(dt, endDate)) cls += ' date-selected date-end'; else if (dt >= startDate && dt <= endDate) cls += ' date-in-range'; }
        else if (startDate && isSameDay(dt, startDate)) cls += ' date-selected date-single';
        if (dt > today) cls += ' text-gray-600 cursor-not-allowed';
        c.innerHTML += `<div class="${cls}" onclick="selectDate('${ds}')">${d}</div>`;
      }
      updateSelectedRangeText();
    }
    function isSameDay(a, b) { return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate(); }
    function selectDate(ds) { const d = new Date(ds + 'T00:00:00'); if (d > today) return; if (selectingStart || (startDate && d < startDate)) { startDate = d; endDate = null; selectingStart = false; } else { endDate = d; selectingStart = true; } renderCalendar(); }
    function setQuickRange(days) { endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate()); if (days === 'all') startDate = new Date(2020, 0, 1); else { startDate = new Date(endDate); startDate.setDate(startDate.getDate() - days); } selectingStart = true; renderCalendar(); }
    function updateSelectedRangeText() { const e = document.getElementById('selectedRangeText'); if (startDate && endDate) e.textContent = `${formatDateShort(startDate)} - ${formatDateShort(endDate)}`; else if (startDate) e.textContent = `${formatDateShort(startDate)} - Selecciona fin`; else e.textContent = 'Selecciona un rango'; }
    function formatDateShort(d) { return d.toLocaleDateString('es-CO', { day: '2-digit', month: 'short', year: 'numeric' }); }
    function applyDateRange() { if (!startDate || !endDate) return; document.getElementById('dateRangeLabel').textContent = `${formatDateShort(startDate)} - ${formatDateShort(endDate)}`; closeDatePicker(); loadAllData(); }
    function getDaysInRange() { if (!startDate || !endDate) return 30; return Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)); }
    function formatCOP(v) { if (v >= 1000000) return '$' + (v / 1000000).toFixed(1) + 'M'; if (v >= 1000) return '$' + (v / 1000).toFixed(0) + 'K'; return '$' + v.toLocaleString('es-CO'); }
    function formatDate(d) { if (!d) return '-'; return new Date(d).toLocaleDateString('es-CO', { day: '2-digit', month: 'short' }); }
    function showLoading() { document.getElementById('loadingState').classList.remove('hidden'); document.getElementById('errorState').classList.add('hidden'); document.getElementById('dashboardContent').classList.add('hidden'); }
    function showError(m) { document.getElementById('loadingState').classList.add('hidden'); document.getElementById('errorState').classList.remove('hidden'); document.getElementById('dashboardContent').classList.add('hidden'); document.getElementById('errorMessage').textContent = m; }
    function showContent() { document.getElementById('loadingState').classList.add('hidden'); document.getElementById('errorState').classList.add('hidden'); document.getElementById('dashboardContent').classList.remove('hidden'); }
    async function fetchAPI(e) { const r = await fetch(`${API_BASE}${e}`); if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); }
    
    async function loadSyncStatus() {
      try {
        const [s, d] = await Promise.all([fetchAPI(`/ml/sync/status?channel_id=${CHANNEL_ID}`), fetchAPI(`/ml/orders/stats?channel_id=${CHANNEL_ID}`)]);
        const e = document.getElementById('syncStatus'), t = d.total_orders || 0;
        if (s.status === 'running') e.innerHTML = `<div class="flex items-center gap-2 text-sm text-ml mb-2"><i data-lucide="refresh-cw" class="w-4 h-4 animate-spin"></i>Sincronizando...</div><div class="w-full bg-[#2e2e2e] rounded-full h-2"><div class="bg-ml h-2 rounded-full" style="width:${s.progress_percent}%"></div></div><p class="text-xs text-gray-500 mt-1">${s.processed_orders?.toLocaleString()} / ${s.total_orders?.toLocaleString()}</p><p class="text-xs text-gray-400 mt-1">En DB: ${t.toLocaleString()}</p>`;
        else e.innerHTML = `<div class="flex items-center gap-2 text-sm text-shopify"><i data-lucide="check-circle" class="w-4 h-4"></i>Datos listos</div><p class="text-xs text-gray-500 mt-1">${t.toLocaleString()} √≥rdenes</p>`;
        lucide.createIcons();
      } catch (e) { console.error(e); }
    }
    
    async function loadDashboard() {
      const d = getDaysInRange(), data = await fetchAPI(`/ml/analytics/dashboard?channel_id=${CHANNEL_ID}&days=${d}`), m = data.metrics;
      document.getElementById('totalRevenue').textContent = m.total_revenue.formatted;
      document.getElementById('totalOrders').textContent = m.total_orders.value.toLocaleString();
      document.getElementById('avgTicket').textContent = m.avg_ticket.formatted;
      const rc = m.total_revenue.change_percent, oc = m.total_orders.change_percent;
      document.getElementById('revenueChange').textContent = (rc >= 0 ? '‚Üë ' : '‚Üì ') + Math.abs(rc) + '% vs anterior';
      document.getElementById('revenueChange').className = 'text-sm mt-1 font-medium ' + (rc >= 0 ? 'text-shopify' : 'text-gastos');
      document.getElementById('ordersChange').textContent = (oc >= 0 ? '‚Üë ' : '‚Üì ') + Math.abs(oc) + '% vs anterior';
      document.getElementById('ordersChange').className = 'text-sm mt-1 font-medium ' + (oc >= 0 ? 'text-shopify' : 'text-gastos');
    }
    
    async function loadSummary() {
      const d = await fetchAPI(`/ml/orders/stats?channel_id=${CHANNEL_ID}`);
      document.getElementById('syncedOrders').textContent = d.total_orders.toLocaleString();
      if (d.date_range.from && d.date_range.to) {
        const f = new Date(d.date_range.from).toLocaleDateString('es-CO', { month: 'short', year: 'numeric' });
        const t = new Date(d.date_range.to).toLocaleDateString('es-CO', { month: 'short', year: 'numeric' });
        document.getElementById('dateRangeInfo').textContent = `${f} - ${t}`;
      }
    }
    
    async function loadSalesChart() {
      const d = getDaysInRange(), data = await fetchAPI(`/ml/analytics/sales-by-day?channel_id=${CHANNEL_ID}&days=${d}`);
      const labels = data.data.map(x => formatDate(x.date)), revenues = data.data.map(x => x.revenue / 1000000);
      const ctx = document.getElementById('salesChart').getContext('2d');
      if (salesChart) salesChart.destroy();
      salesChart = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: 'Ventas', data: revenues, borderColor: '#eab308', backgroundColor: 'rgba(234,179,8,0.1)', tension: 0.4, fill: true, pointRadius: 2 }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#2e2e2e' }, ticks: { color: '#888', maxTicksLimit: 10 } }, y: { grid: { color: '#2e2e2e' }, ticks: { color: '#888', callback: v => '$' + v + 'M' } } } } });
    }
    
    async function loadStatusChart() {
      const d = getDaysInRange(), data = await fetchAPI(`/ml/analytics/orders-by-status?channel_id=${CHANNEL_ID}&days=${d}`);
      const colors = { 'paid': '#22c55e', 'cancelled': '#ef4444', 'pending': '#eab308', 'confirmed': '#3b82f6', 'partially_refunded': '#f97316' };
      const labels = data.statuses.map(s => s.status), counts = data.statuses.map(s => s.count), bgColors = data.statuses.map(s => colors[s.status] || '#6b7280');
      const ctx = document.getElementById('statusChart').getContext('2d');
      if (statusChart) statusChart.destroy();
      statusChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data: counts, backgroundColor: bgColors, borderWidth: 0 }] }, options: { responsive: true, plugins: { legend: { display: false } }, cutout: '70%' } });
      document.getElementById('statusLegend').innerHTML = data.statuses.map(s => `<div class="flex items-center justify-between"><span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full" style="background:${colors[s.status] || '#6b7280'}"></span>${s.status}</span><span class="font-medium">${s.count}</span></div>`).join('');
    }
    
    async function loadTopProducts() {
      const d = getDaysInRange(), data = await fetchAPI(`/ml/analytics/top-products?channel_id=${CHANNEL_ID}&days=${d}&limit=10`);
      const tb = document.getElementById('productsTable');
      if (!data.products?.length) { tb.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">No hay datos</td></tr>'; return; }
      tb.innerHTML = data.products.map((p, i) => `<tr class="border-b border-[#2e2e2e] hover:bg-[#242424] cursor-pointer"><td class="py-3 text-gray-500">${i + 1}</td><td class="py-3 font-medium">${p.title}</td><td class="py-3 text-right">${p.units_sold.toLocaleString()}</td><td class="py-3 text-right font-bold text-shopify">${formatCOP(p.revenue)}</td><td class="py-3 text-right text-gray-400">${p.orders_count}</td></tr>`).join('');
    }
    
    async function loadRecentOrders() {
      const data = await fetchAPI(`/ml/analytics/recent-orders?channel_id=${CHANNEL_ID}&limit=10`);
      const tb = document.getElementById('ordersTable'), colors = { 'paid': 'text-shopify', 'cancelled': 'text-gastos', 'pending': 'text-ml', 'partially_refunded': 'text-dropi' };
      tb.innerHTML = data.orders.map(o => `<tr class="border-b border-[#2e2e2e] hover:bg-[#242424]"><td class="py-3 font-mono text-xs text-gray-400">${o.id}</td><td class="py-3">${formatDate(o.date)}</td><td class="py-3">${o.buyer || '-'}</td><td class="py-3 ${colors[o.status] || 'text-gray-400'} font-medium">${o.status}</td><td class="py-3 text-right font-bold">${formatCOP(o.total)}</td></tr>`).join('');
    }
    
    async function loadAllData() { showLoading(); try { await Promise.all([loadSyncStatus(), loadDashboard(), loadSummary(), loadSalesChart(), loadStatusChart(), loadTopProducts(), loadRecentOrders()]); showContent(); lucide.createIcons(); } catch (e) { console.error(e); showError(e.message); } }
    
    async function loadMLResumen() {
      try {
        const d = await fetchAPI(`/ml/orders/stats?channel_id=${CHANNEL_ID}`);
        document.getElementById('ml-cuenta1-revenue').textContent = formatCOP(d.total_revenue_cop);
        document.getElementById('ml-cuenta1-orders').textContent = d.total_orders.toLocaleString() + ' √≥rdenes';
        document.getElementById('ml-total-revenue').textContent = formatCOP(d.total_revenue_cop);
        document.getElementById('ml-total-orders').textContent = d.total_orders.toLocaleString();
        document.getElementById('ml-total-net').textContent = formatCOP(d.total_revenue_cop);
        lucide.createIcons();
      } catch (e) { console.error(e); }
    }
    
    async function loadMLCuenta1() {
      try {
        const d = await fetchAPI(`/ml/orders/stats?channel_id=${CHANNEL_ID}`);
        document.getElementById('c1-revenue').textContent = formatCOP(d.total_revenue_cop);
        document.getElementById('c1-orders').textContent = d.total_orders.toLocaleString();
        document.getElementById('c1-net').textContent = formatCOP(d.total_revenue_cop);
        const b = d.orders_by_status;
        document.getElementById('c1-status-breakdown').innerHTML = `
          <div class="bg-[#0a0a0a] rounded-lg p-4 text-center"><p class="text-gray-500 text-sm">Pagadas</p><p class="text-xl font-bold text-green-500">${(b.paid || 0).toLocaleString()}</p></div>
          <div class="bg-[#0a0a0a] rounded-lg p-4 text-center"><p class="text-gray-500 text-sm">Canceladas</p><p class="text-xl font-bold text-red-500">${(b.cancelled || 0).toLocaleString()}</p></div>
          <div class="bg-[#0a0a0a] rounded-lg p-4 text-center"><p class="text-gray-500 text-sm">Reembolsos</p><p class="text-xl font-bold text-orange-500">${(b.partially_refunded || 0).toLocaleString()}</p></div>
          <div class="bg-[#0a0a0a] rounded-lg p-4 text-center"><p class="text-gray-500 text-sm">Total</p><p class="text-xl font-bold">${d.total_orders.toLocaleString()}</p></div>`;
        const p = await fetchAPI(`/ml/analytics/top-products?channel_id=${CHANNEL_ID}&days=365&limit=10`);
        document.getElementById('c1-products').innerHTML = p.products.map((x, i) => `<tr class="border-b border-[#2e2e2e] hover:bg-[#242424]"><td class="py-2 text-gray-500">${i + 1}</td><td class="py-2">${x.title}</td><td class="py-2 text-right">${x.units_sold.toLocaleString()}</td><td class="py-2 text-right text-green-500 font-medium">${formatCOP(x.revenue)}</td></tr>`).join('');
        lucide.createIcons();
      } catch (e) { console.error(e); }
    }
    
    async function loadMLProductos() {
      try {
        const d = await fetchAPI(`/ml/analytics/top-products?channel_id=${CHANNEL_ID}&days=365&limit=500`);
        allProducts = d.products || []; filteredProducts = [...allProducts]; currentPage = 1; renderProductsTable();
      } catch (e) { console.error(e); }
    }
    
    function renderProductsTable() {
      const s = (currentPage - 1) * productsPerPage, e = s + productsPerPage, pg = filteredProducts.slice(s, e);
      document.getElementById('products-showing').textContent = Math.min(e, filteredProducts.length);
      document.getElementById('products-total').textContent = filteredProducts.length;
      document.getElementById('current-page').textContent = currentPage;
      document.getElementById('total-pages').textContent = Math.ceil(filteredProducts.length / productsPerPage);
      document.getElementById('prev-page-btn').disabled = currentPage === 1;
      document.getElementById('next-page-btn').disabled = e >= filteredProducts.length;
      document.getElementById('all-products-table').innerHTML = pg.map((p, i) => `<tr class="border-b border-[#2e2e2e] hover:bg-[#242424] cursor-pointer"><td class="py-3 text-gray-500">${s + i + 1}</td><td class="py-3 font-medium">${p.title}</td><td class="py-3 text-right">${p.units_sold.toLocaleString()}</td><td class="py-3 text-right text-green-500 font-bold">${formatCOP(p.revenue)}</td><td class="py-3 text-right text-gray-400">${p.orders_count}</td><td class="py-3 text-right">${formatCOP(p.revenue / p.orders_count)}</td></tr>`).join('');
    }
    
    function filterProducts() { const s = document.getElementById('productSearch').value.toLowerCase(); filteredProducts = allProducts.filter(p => p.title.toLowerCase().includes(s)); currentPage = 1; renderProductsTable(); }
    function sortProducts() { const s = document.getElementById('productSort').value; if (s === 'revenue') filteredProducts.sort((a, b) => b.revenue - a.revenue); else if (s === 'units') filteredProducts.sort((a, b) => b.units_sold - a.units_sold); else if (s === 'orders') filteredProducts.sort((a, b) => b.orders_count - a.orders_count); else if (s === 'name') filteredProducts.sort((a, b) => a.title.localeCompare(b.title)); currentPage = 1; renderProductsTable(); }
    function prevProductPage() { if (currentPage > 1) { currentPage--; renderProductsTable(); } }
    function nextProductPage() { if (currentPage < Math.ceil(filteredProducts.length / productsPerPage)) { currentPage++; renderProductsTable(); } }
    
    document.addEventListener('DOMContentLoaded', () => { lucide.createIcons(); document.getElementById('dateRangeLabel').textContent = `${formatDateShort(startDate)} - ${formatDateShort(endDate)}`; navigateTo('dashboard'); setInterval(loadSyncStatus, 30000); });
  </script>
</body>
</html>
