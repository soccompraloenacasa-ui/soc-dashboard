<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOC Dashboard - Compralo en Casa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ml: '#eab308',
            dropi: '#ea580c',
            shopify: '#16a34a',
            gastos: '#dc2626',
            profit: '#2563eb',
          }
        }
      }
    }
  </script>
  <style>
    .date-in-range { background: rgba(37, 99, 235, 0.3); }
    .date-selected { background: #2563eb; color: white; border-radius: 6px; }
    .date-start { border-radius: 6px 0 0 6px; }
    .date-end { border-radius: 0 6px 6px 0; }
    .date-single { border-radius: 6px; }
  </style>
</head>
<body class="bg-[#0a0a0a] text-white min-h-screen">
  
  <div class="flex h-screen overflow-hidden">
    
    <aside class="w-64 bg-[#121212] border-r border-[#2e2e2e] flex flex-col">
      <div class="p-6 border-b border-[#2e2e2e]">
        <h1 class="text-xl font-bold">SOC Hub</h1>
        <p class="text-gray-500 text-sm">Compralo en Casa</p>
      </div>
      
      <nav class="flex-1 p-4 space-y-2">
        <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg bg-[#242424] text-white">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
          Dashboard
        </a>
        <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-[#1a1a1a] hover:text-ml transition">
          <i data-lucide="shopping-bag" class="w-5 h-5 text-ml"></i>
          Mercado Libre
        </a>
        <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-[#1a1a1a] hover:text-dropi transition">
          <i data-lucide="package" class="w-5 h-5 text-dropi"></i>
          Dropi
        </a>
        <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-[#1a1a1a] hover:text-shopify transition">
          <i data-lucide="store" class="w-5 h-5 text-shopify"></i>
          Shopify
        </a>
      </nav>
      
      <div class="p-4 border-t border-[#2e2e2e]">
        <div id="syncStatus" class="bg-[#1a1a1a] rounded-lg p-3">
          <div class="flex items-center gap-2 text-sm text-gray-500 mb-2">
            <i data-lucide="loader" class="w-4 h-4 animate-spin"></i>
            Cargando...
          </div>
        </div>
      </div>
    </aside>
    
    <main class="flex-1 overflow-auto">
      
      <header class="bg-[#121212] border-b border-[#2e2e2e] px-6 py-4 sticky top-0 z-20">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-2xl font-bold">Dashboard</h2>
            <p class="text-gray-500">Datos reales de Mercado Libre</p>
          </div>
          
          <div class="flex items-center gap-4">
            <!-- Date Range Picker -->
            <div class="relative">
              <button id="datePickerBtn" onclick="toggleDatePicker()" class="flex items-center gap-2 bg-[#1a1a1a] rounded-lg px-4 py-2 hover:bg-[#242424] transition border border-[#2e2e2e]">
                <i data-lucide="calendar" class="w-4 h-4 text-gray-400"></i>
                <span id="dateRangeLabel" class="text-sm">Ultimos 30 dias</span>
                <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400"></i>
              </button>
              
              <!-- Date Picker Dropdown -->
              <div id="datePickerDropdown" class="hidden absolute right-0 top-12 bg-[#1a1a1a] border border-[#2e2e2e] rounded-xl shadow-2xl p-4 w-[320px] z-50">
                <!-- Quick Options -->
                <div class="flex flex-wrap gap-2 mb-4 pb-4 border-b border-[#2e2e2e]">
                  <button onclick="setQuickRange(7)" class="px-3 py-1.5 text-xs bg-[#242424] hover:bg-[#2e2e2e] rounded-lg transition">7 dias</button>
                  <button onclick="setQuickRange(30)" class="px-3 py-1.5 text-xs bg-[#242424] hover:bg-[#2e2e2e] rounded-lg transition">30 dias</button>
                  <button onclick="setQuickRange(90)" class="px-3 py-1.5 text-xs bg-[#242424] hover:bg-[#2e2e2e] rounded-lg transition">90 dias</button>
                  <button onclick="setQuickRange(365)" class="px-3 py-1.5 text-xs bg-[#242424] hover:bg-[#2e2e2e] rounded-lg transition">1 año</button>
                  <button onclick="setQuickRange('all')" class="px-3 py-1.5 text-xs bg-[#242424] hover:bg-[#2e2e2e] rounded-lg transition">Todo</button>
                </div>
                
                <!-- Calendar Header -->
                <div class="flex items-center justify-between mb-3">
                  <button onclick="changeMonth(-1)" class="p-1 hover:bg-[#242424] rounded-lg transition">
                    <i data-lucide="chevron-left" class="w-5 h-5"></i>
                  </button>
                  <span id="calendarMonth" class="font-semibold"></span>
                  <button onclick="changeMonth(1)" class="p-1 hover:bg-[#242424] rounded-lg transition">
                    <i data-lucide="chevron-right" class="w-5 h-5"></i>
                  </button>
                </div>
                
                <!-- Calendar Grid -->
                <div class="grid grid-cols-7 gap-1 text-center text-xs mb-2">
                  <div class="text-gray-500 py-1">Lu</div>
                  <div class="text-gray-500 py-1">Ma</div>
                  <div class="text-gray-500 py-1">Mi</div>
                  <div class="text-gray-500 py-1">Ju</div>
                  <div class="text-gray-500 py-1">Vi</div>
                  <div class="text-gray-500 py-1">Sa</div>
                  <div class="text-gray-500 py-1">Do</div>
                </div>
                <div id="calendarDays" class="grid grid-cols-7 gap-1 text-center text-sm"></div>
                
                <!-- Selected Range Display -->
                <div class="mt-4 pt-4 border-t border-[#2e2e2e] flex items-center justify-between">
                  <div class="text-xs text-gray-400">
                    <span id="selectedRangeText">Selecciona un rango</span>
                  </div>
                  <button onclick="applyDateRange()" class="px-4 py-1.5 bg-profit text-white text-sm font-medium rounded-lg hover:bg-blue-600 transition">
                    Aplicar
                  </button>
                </div>
              </div>
            </div>
            
            <button onclick="loadAllData()" class="px-4 py-2 bg-ml text-black font-medium rounded-lg hover:bg-yellow-400 transition flex items-center gap-2">
              <i data-lucide="refresh-cw" class="w-4 h-4"></i>
              Actualizar
            </button>
          </div>
        </div>
      </header>
      
      <div class="p-6 space-y-6">
        
        <div id="loadingState" class="text-center py-20">
          <i data-lucide="loader" class="w-12 h-12 animate-spin mx-auto text-ml mb-4"></i>
          <p class="text-gray-400">Cargando datos del API...</p>
        </div>
        
        <div id="errorState" class="hidden text-center py-20">
          <i data-lucide="alert-circle" class="w-12 h-12 mx-auto text-red-500 mb-4"></i>
          <p class="text-red-400 font-medium">Error al cargar datos</p>
          <p class="text-gray-500 text-sm mt-2" id="errorMessage"></p>
          <button onclick="loadAllData()" class="mt-4 px-4 py-2 bg-[#1a1a1a] rounded-lg hover:bg-[#242424] transition">Reintentar</button>
        </div>
        
        <div id="dashboardContent" class="hidden space-y-6">
          
          <div class="grid grid-cols-4 gap-4">
            <div class="bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
              <div class="flex items-center justify-between mb-3">
                <span class="text-gray-500 text-sm">Ventas Totales</span>
                <div class="p-2 bg-shopify/20 rounded-lg"><i data-lucide="dollar-sign" class="w-5 h-5 text-shopify"></i></div>
              </div>
              <p class="text-2xl font-bold" id="totalRevenue">$0</p>
              <p class="text-sm mt-1 font-medium" id="revenueChange">-</p>
            </div>
            
            <div class="bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
              <div class="flex items-center justify-between mb-3">
                <span class="text-gray-500 text-sm">Ordenes</span>
                <div class="p-2 bg-ml/20 rounded-lg"><i data-lucide="shopping-cart" class="w-5 h-5 text-ml"></i></div>
              </div>
              <p class="text-2xl font-bold" id="totalOrders">0</p>
              <p class="text-sm mt-1 font-medium" id="ordersChange">-</p>
            </div>
            
            <div class="bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
              <div class="flex items-center justify-between mb-3">
                <span class="text-gray-500 text-sm">Ticket Promedio</span>
                <div class="p-2 bg-dropi/20 rounded-lg"><i data-lucide="tag" class="w-5 h-5 text-dropi"></i></div>
              </div>
              <p class="text-2xl font-bold" id="avgTicket">$0</p>
              <p class="text-gray-500 text-sm mt-1">por orden</p>
            </div>
            
            <div class="bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
              <div class="flex items-center justify-between mb-3">
                <span class="text-gray-500 text-sm">Ordenes Sincronizadas</span>
                <div class="p-2 bg-profit/20 rounded-lg"><i data-lucide="database" class="w-5 h-5 text-profit"></i></div>
              </div>
              <p class="text-2xl font-bold" id="syncedOrders">0</p>
              <p class="text-gray-500 text-sm mt-1" id="dateRangeInfo">-</p>
            </div>
          </div>
          
          <div class="grid grid-cols-3 gap-4">
            <div class="col-span-2 bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold">Ventas por Dia</h3>
                <span class="text-ml text-sm">Mercado Libre</span>
              </div>
              <canvas id="salesChart" height="200"></canvas>
            </div>
            
            <div class="bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
              <h3 class="font-semibold mb-4">Estado de Ordenes</h3>
              <canvas id="statusChart" height="200"></canvas>
              <div id="statusLegend" class="mt-4 space-y-2 text-sm"></div>
            </div>
          </div>
          
          <div class="bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold">Top Productos</h3>
              <span class="text-gray-500 text-sm" id="productsPeriod">-</span>
            </div>
            <table class="w-full">
              <thead>
                <tr class="text-left text-gray-500 text-sm border-b border-[#2e2e2e]">
                  <th class="pb-3 font-medium">#</th>
                  <th class="pb-3 font-medium">Producto</th>
                  <th class="pb-3 font-medium text-right">Unidades</th>
                  <th class="pb-3 font-medium text-right">Ingresos</th>
                  <th class="pb-3 font-medium text-right">Ordenes</th>
                </tr>
              </thead>
              <tbody id="productsTable" class="text-sm">
                <tr><td colspan="5" class="py-4 text-center text-gray-500">Cargando...</td></tr>
              </tbody>
            </table>
          </div>
          
          <div class="bg-[#1a1a1a] rounded-xl p-5 border border-[#2e2e2e]">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold">Ordenes Recientes</h3>
            </div>
            <table class="w-full">
              <thead>
                <tr class="text-left text-gray-500 text-sm border-b border-[#2e2e2e]">
                  <th class="pb-3 font-medium">ID</th>
                  <th class="pb-3 font-medium">Fecha</th>
                  <th class="pb-3 font-medium">Comprador</th>
                  <th class="pb-3 font-medium">Estado</th>
                  <th class="pb-3 font-medium text-right">Total</th>
                </tr>
              </thead>
              <tbody id="ordersTable" class="text-sm">
                <tr><td colspan="5" class="py-4 text-center text-gray-500">Cargando...</td></tr>
              </tbody>
            </table>
          </div>
          
        </div>
      </div>
    </main>
  </div>
  
  <script>
    const API_BASE = 'https://mercado-libre-production-b0cc.up.railway.app/api/v1';
    const CHANNEL_ID = 1;
    let salesChart = null;
    let statusChart = null;
    
    // Date Range State
    let currentMonth = new Date();
    let startDate = null;
    let endDate = null;
    let selectingStart = true;
    
    // Initialize with last 30 days
    const today = new Date();
    endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    startDate = new Date(endDate);
    startDate.setDate(startDate.getDate() - 30);
    
    // Date Picker Functions
    function toggleDatePicker() {
      const dropdown = document.getElementById('datePickerDropdown');
      dropdown.classList.toggle('hidden');
      if (!dropdown.classList.contains('hidden')) {
        renderCalendar();
        lucide.createIcons();
      }
    }
    
    function closeDatePicker() {
      document.getElementById('datePickerDropdown').classList.add('hidden');
    }
    
    // Close on click outside
    document.addEventListener('click', (e) => {
      const picker = document.getElementById('datePickerDropdown');
      const btn = document.getElementById('datePickerBtn');
      if (!picker.contains(e.target) && !btn.contains(e.target)) {
        picker.classList.add('hidden');
      }
    });
    
    function changeMonth(delta) {
      currentMonth.setMonth(currentMonth.getMonth() + delta);
      renderCalendar();
    }
    
    function renderCalendar() {
      const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      
      document.getElementById('calendarMonth').textContent = 
        `${monthNames[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
      
      const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
      const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
      
      // Adjust for Monday start (0 = Monday, 6 = Sunday)
      let startDayOfWeek = firstDay.getDay() - 1;
      if (startDayOfWeek < 0) startDayOfWeek = 6;
      
      const daysContainer = document.getElementById('calendarDays');
      daysContainer.innerHTML = '';
      
      // Empty cells before first day
      for (let i = 0; i < startDayOfWeek; i++) {
        daysContainer.innerHTML += '<div class="py-2"></div>';
      }
      
      // Days of month
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const date = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day);
        const dateStr = date.toISOString().split('T')[0];
        
        let classes = 'py-2 cursor-pointer hover:bg-[#242424] rounded-lg transition';
        
        // Check if in range
        if (startDate && endDate) {
          const isStart = isSameDay(date, startDate);
          const isEnd = isSameDay(date, endDate);
          const inRange = date >= startDate && date <= endDate;
          
          if (isStart && isEnd) {
            classes += ' date-selected date-single';
          } else if (isStart) {
            classes += ' date-selected date-start';
          } else if (isEnd) {
            classes += ' date-selected date-end';
          } else if (inRange) {
            classes += ' date-in-range';
          }
        } else if (startDate && isSameDay(date, startDate)) {
          classes += ' date-selected date-single';
        }
        
        // Future dates
        if (date > today) {
          classes += ' text-gray-600 cursor-not-allowed';
        }
        
        daysContainer.innerHTML += `<div class="${classes}" onclick="selectDate('${dateStr}')">${day}</div>`;
      }
      
      updateSelectedRangeText();
    }
    
    function isSameDay(d1, d2) {
      return d1.getFullYear() === d2.getFullYear() &&
             d1.getMonth() === d2.getMonth() &&
             d1.getDate() === d2.getDate();
    }
    
    function selectDate(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      if (date > today) return;
      
      if (selectingStart || (startDate && date < startDate)) {
        startDate = date;
        endDate = null;
        selectingStart = false;
      } else {
        endDate = date;
        selectingStart = true;
      }
      
      renderCalendar();
    }
    
    function setQuickRange(days) {
      endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      
      if (days === 'all') {
        startDate = new Date(2020, 0, 1); // Far back
      } else {
        startDate = new Date(endDate);
        startDate.setDate(startDate.getDate() - days);
      }
      
      selectingStart = true;
      renderCalendar();
    }
    
    function updateSelectedRangeText() {
      const el = document.getElementById('selectedRangeText');
      if (startDate && endDate) {
        el.textContent = `${formatDateShort(startDate)} - ${formatDateShort(endDate)}`;
      } else if (startDate) {
        el.textContent = `${formatDateShort(startDate)} - Selecciona fin`;
      } else {
        el.textContent = 'Selecciona un rango';
      }
    }
    
    function formatDateShort(date) {
      return date.toLocaleDateString('es-CO', { day: '2-digit', month: 'short', year: 'numeric' });
    }
    
    function applyDateRange() {
      if (!startDate || !endDate) return;
      
      document.getElementById('dateRangeLabel').textContent = 
        `${formatDateShort(startDate)} - ${formatDateShort(endDate)}`;
      
      closeDatePicker();
      loadAllData();
    }
    
    function getDaysInRange() {
      if (!startDate || !endDate) return 30;
      return Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
    }
    
    function formatCOP(value) {
      if (value >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M';
      if (value >= 1000) return '$' + (value / 1000).toFixed(0) + 'K';
      return '$' + value.toLocaleString('es-CO');
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      return new Date(dateStr).toLocaleDateString('es-CO', { day: '2-digit', month: 'short' });
    }
    
    function showLoading() {
      document.getElementById('loadingState').classList.remove('hidden');
      document.getElementById('errorState').classList.add('hidden');
      document.getElementById('dashboardContent').classList.add('hidden');
    }
    
    function showError(message) {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('errorState').classList.remove('hidden');
      document.getElementById('dashboardContent').classList.add('hidden');
      document.getElementById('errorMessage').textContent = message;
    }
    
    function showContent() {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('errorState').classList.add('hidden');
      document.getElementById('dashboardContent').classList.remove('hidden');
    }
    
    async function fetchAPI(endpoint) {
      const response = await fetch(`${API_BASE}${endpoint}`);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return response.json();
    }
    
    async function loadSyncStatus() {
      try {
        const [syncData, summaryData] = await Promise.all([
          fetchAPI(`/ml/sync/status?channel_id=${CHANNEL_ID}`),
          fetchAPI(`/ml/analytics/summary?channel_id=${CHANNEL_ID}`)
        ]);
        const el = document.getElementById('syncStatus');
        const totalInDB = summaryData.all_time?.orders || 0;
        
        if (syncData.status === 'running') {
          el.innerHTML = `<div class="flex items-center gap-2 text-sm text-ml mb-2"><i data-lucide="refresh-cw" class="w-4 h-4 animate-spin"></i>Sincronizando...</div><div class="w-full bg-[#2e2e2e] rounded-full h-2"><div class="bg-ml h-2 rounded-full" style="width: ${syncData.progress_percent}%"></div></div><p class="text-xs text-gray-500 mt-1">${syncData.processed_orders?.toLocaleString()} / ${syncData.total_orders?.toLocaleString()}</p><p class="text-xs text-gray-400 mt-1">En DB: ${totalInDB.toLocaleString()}</p>`;
        } else {
          el.innerHTML = `<div class="flex items-center gap-2 text-sm text-shopify"><i data-lucide="check-circle" class="w-4 h-4"></i>Datos listos</div><p class="text-xs text-gray-500 mt-1">${totalInDB.toLocaleString()} ordenes en DB</p>`;
        }
        lucide.createIcons();
      } catch (e) { console.error('Error:', e); }
    }
    
    async function loadDashboard() {
      const days = getDaysInRange();
      const data = await fetchAPI(`/ml/analytics/dashboard?channel_id=${CHANNEL_ID}&days=${days}`);
      const m = data.metrics;
      document.getElementById('totalRevenue').textContent = m.total_revenue.formatted;
      document.getElementById('totalOrders').textContent = m.total_orders.value.toLocaleString();
      document.getElementById('avgTicket').textContent = m.avg_ticket.formatted;
      const rc = m.total_revenue.change_percent;
      const oc = m.total_orders.change_percent;
      document.getElementById('revenueChange').textContent = (rc >= 0 ? '↑ ' : '↓ ') + Math.abs(rc) + '% vs anterior';
      document.getElementById('revenueChange').className = 'text-sm mt-1 font-medium ' + (rc >= 0 ? 'text-shopify' : 'text-gastos');
      document.getElementById('ordersChange').textContent = (oc >= 0 ? '↑ ' : '↓ ') + Math.abs(oc) + '% vs anterior';
      document.getElementById('ordersChange').className = 'text-sm mt-1 font-medium ' + (oc >= 0 ? 'text-shopify' : 'text-gastos');
    }
    
    async function loadSummary() {
      const data = await fetchAPI(`/ml/analytics/summary?channel_id=${CHANNEL_ID}`);
      document.getElementById('syncedOrders').textContent = data.all_time.orders.toLocaleString();
      if (data.all_time.first_order && data.all_time.last_order) {
        const from = new Date(data.all_time.first_order).toLocaleDateString('es-CO', { month: 'short', year: 'numeric' });
        const to = new Date(data.all_time.last_order).toLocaleDateString('es-CO', { month: 'short', year: 'numeric' });
        document.getElementById('dateRangeInfo').textContent = `${from} - ${to}`;
      }
    }
    
    async function loadSalesChart() {
      const days = getDaysInRange();
      const data = await fetchAPI(`/ml/analytics/sales-by-day?channel_id=${CHANNEL_ID}&days=${days}`);
      const labels = data.data.map(d => formatDate(d.date));
      const revenues = data.data.map(d => d.revenue / 1000000);
      const ctx = document.getElementById('salesChart').getContext('2d');
      if (salesChart) salesChart.destroy();
      salesChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Ventas', data: revenues, borderColor: '#eab308', backgroundColor: 'rgba(234,179,8,0.1)', tension: 0.4, fill: true, pointRadius: 2 }] },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#2e2e2e' }, ticks: { color: '#888', maxTicksLimit: 10 } }, y: { grid: { color: '#2e2e2e' }, ticks: { color: '#888', callback: v => '$' + v + 'M' } } } }
      });
    }
    
    async function loadStatusChart() {
      const days = getDaysInRange();
      const data = await fetchAPI(`/ml/analytics/orders-by-status?channel_id=${CHANNEL_ID}&days=${days}`);
      const colors = { 'paid': '#22c55e', 'cancelled': '#ef4444', 'pending': '#eab308', 'confirmed': '#3b82f6' };
      const labels = data.statuses.map(s => s.status);
      const counts = data.statuses.map(s => s.count);
      const bgColors = data.statuses.map(s => colors[s.status] || '#6b7280');
      const ctx = document.getElementById('statusChart').getContext('2d');
      if (statusChart) statusChart.destroy();
      statusChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data: counts, backgroundColor: bgColors, borderWidth: 0 }] }, options: { responsive: true, plugins: { legend: { display: false } }, cutout: '70%' } });
      document.getElementById('statusLegend').innerHTML = data.statuses.map(s => `<div class="flex items-center justify-between"><span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full" style="background: ${colors[s.status] || '#6b7280'}"></span>${s.status}</span><span class="font-medium">${s.count}</span></div>`).join('');
    }
    
    async function loadTopProducts() {
      const days = getDaysInRange();
      const data = await fetchAPI(`/ml/analytics/top-products?channel_id=${CHANNEL_ID}&days=${days}&limit=10`);
      document.getElementById('productsPeriod').textContent = `${formatDateShort(startDate)} - ${formatDateShort(endDate)}`;
      const tbody = document.getElementById('productsTable');
      if (!data.products?.length) { tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">No hay datos</td></tr>'; return; }
      tbody.innerHTML = data.products.map((p, i) => `<tr class="border-b border-[#2e2e2e] hover:bg-[#242424]"><td class="py-3 text-gray-500">${i + 1}</td><td class="py-3 font-medium">${p.title}</td><td class="py-3 text-right">${p.units_sold.toLocaleString()}</td><td class="py-3 text-right font-bold text-shopify">${formatCOP(p.revenue)}</td><td class="py-3 text-right text-gray-400">${p.orders_count}</td></tr>`).join('');
    }
    
    async function loadRecentOrders() {
      const data = await fetchAPI(`/ml/analytics/recent-orders?channel_id=${CHANNEL_ID}&limit=10`);
      const tbody = document.getElementById('ordersTable');
      const colors = { 'paid': 'text-shopify', 'cancelled': 'text-gastos', 'pending': 'text-ml' };
      tbody.innerHTML = data.orders.map(o => `<tr class="border-b border-[#2e2e2e] hover:bg-[#242424]"><td class="py-3 font-mono text-xs text-gray-400">${o.id}</td><td class="py-3">${formatDate(o.date)}</td><td class="py-3">${o.buyer || '-'}</td><td class="py-3 ${colors[o.status] || 'text-gray-400'} font-medium">${o.status}</td><td class="py-3 text-right font-bold">${formatCOP(o.total)}</td></tr>`).join('');
    }
    
    async function loadAllData() {
      showLoading();
      try {
        await Promise.all([loadSyncStatus(), loadDashboard(), loadSummary(), loadSalesChart(), loadStatusChart(), loadTopProducts(), loadRecentOrders()]);
        showContent();
        lucide.createIcons();
      } catch (error) {
        console.error('Error:', error);
        showError(error.message);
      }
    }
    
    document.addEventListener('DOMContentLoaded', () => { 
      lucide.createIcons(); 
      document.getElementById('dateRangeLabel').textContent = `${formatDateShort(startDate)} - ${formatDateShort(endDate)}`;
      loadAllData(); 
      setInterval(loadSyncStatus, 30000); 
    });
  </script>
  
</body>
</html>
